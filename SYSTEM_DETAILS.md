# ETF 추천 시스템 상세 매뉴얼

## 1. 시스템 개요

이 시스템은 여러 ETF의 가격 흐름을 분석해 **최근 상승 추세가 강한 종목을 자동으로 추천**합니다.
이동평균(MA) 대비 현재 가격 위치, 최근 1~3주의 수익률, 연속 상승 일수 등을 종합적으로 반영해
ETF별 '상승 강도 점수'를 계산합니다.

---

## 2. 작동 원리

### (0) 종목 대표 추림

- `zsettings/stocks/<국가>.json`에서 ETF를 읽은 뒤, **카테고리마다 직전 3개월 수익률(`3_month_earn_rate`)이 가장 높은 1개**만 남겨 공통 후보군을 만듭니다.
- `config.CATEGORY_EXCEPTIONS` 에 정의된 예외 카테고리는 필터링하지 않고 모두 포함합니다.
- 각 계좌가 참고하는 **벤치마크 ETF**는 카테고리와 무관하게 항상 추가합니다.
- 대표군을 만든 뒤 추천·백테스트·튜닝·캐시 갱신이 모두 동일한 티커 목록을 사용합니다.

### (1) 추세 분석 (MAPS 전략)

- 각 ETF의 현재 가격이 이동평균선 위에 얼마나 위치하는지 측정합니다.
- 최근 1·2·3주 수익률, 연속 상승 일수 등을 함께 반영해 종합 점수를 계산합니다.
- 점수가 높을수록 상승 추세가 뚜렷한 ETF로 간주합니다.

### (2) RSI 과매수 감지

- RSI(Relative Strength Index) 지표로 과열 종목을 감지합니다.
- RSI 점수가 임계값 이상으로 올라가면 과매수 상태로 판단합니다.
- 과매수 종목은 자동으로 일부 매도하거나 신규 매수를 차단합니다.

### (3) 추천 절차

1. 투자 가능한 ETF 후보군을 생성합니다.
2. 각 ETF의 MAPS 점수와 RSI 점수를 계산합니다.
3. 점수를 종합해 상위권 ETF를 추천합니다.
4. 보유 중인 ETF라도 점수가 낮으면, 더 높은 점수를 가진 후보로 교체합니다.
5. 포트폴리오 여유가 있을 때는 신규 편입을 제안하고,
   여유가 없으면 기존 종목과 점수 차가 충분히 클 때만 교체합니다.
6. ETF 가격이 이동평균선 아래로 떨어지거나 RSI 과매수 상태면 매도 신호로 판단합니다.

---

## 3. 시장 상황 모니터링 (Market Regime)

시장의 전반적인 상황을 대시보드에서 참고용으로 표시합니다.

### 시장 레짐 판단 기준

- **주요 지수**(S&P 500, NASDAQ 등)의 가격이 이동평균선 대비 어디에 위치하는지 확인
- 이동평균선 아래로 떨어지면 "시장 위험" 신호 표시

### 활용 방법

- **대시보드 참고용**: 시장 상태를 시각적으로 확인 가능
- **실제 매매 영향 없음**: 시장 레짐 정보는 참고용으로만 사용되며, 자동 매매 로직에는 영향을 주지 않습니다
- **투자자 판단 지원**: 시장 상황을 고려한 수동 의사결정에 활용 가능

이를 통해 **개별 ETF의 추세**와 **시장 전체 상황(레짐)** 을 함께 모니터링할 수 있습니다.

---

## 4. 포지션 상태 로직

각 ETF는 시스템 내부에서 다음과 같은 상태를 가집니다.

| 상태 | 설명 |
|------|------|
| **WAIT** | 기본 대기 상태. 조건 미충족 또는 제약 발생. |
| **BUY** | 신규 매수 제안. 상승세 뚜렷, 리스크 낮음. |
| **HOLD** | 보유 유지. 여전히 상승세 유지 중. |
| **SELL_TREND** | 이동평균선 아래로 떨어져 추세 약화. 전량 매도 제안. |
| **SELL_RSI** | RSI 과매수 상태. 전량 매도 제안. |
| **CUT_STOPLOSS** | 손실률이 설정 한도를 초과해 손절 지시. |
| **SELL_REPLACE** | 교체 대상 선정 시 기존 종목 매도. |
| **BUY_REPLACE** | 교체 대상 선정 시 신규 종목 편입. |

WAIT 상태의 예시 메모:

- `최소 5.0점수 미만 (현재 2.2)` → 전략 설정의 `MIN_BUY_SCORE` 허들을 통과하지 못해 대기 중
- `카테고리 중복` → 동일 카테고리 ETF를 이미 보유하고 있어 신규 편입 불가

### 매수 예산 계산

매수 예산은 다음 공식으로 계산됩니다:

```
매수 예산 = min(
    현재 총자산 / 포트폴리오 목표 종목 수,
    보유 현금
)
```

이를 통해 **비중 과다 투자**를 방지하고 균등 분배를 유지합니다.

---

## 5. 리스크 및 제약 조건

### (1) 카테고리 중복 방지

- 동일 카테고리(섹터) ETF가 이미 포트폴리오에 있으면 WAIT 상태로 유지
- 예: 기술주 ETF를 이미 보유 중이면 다른 기술주 ETF는 편입 불가
- **예외**: `config.CATEGORY_EXCEPTIONS` 에 정의된 카테고리는 중복 제한에서 제외됨

### (2) 시장 레짐 리스크 오프

- 전체 시장 리스크가 높을 시:
  - 신규 매수 차단 또는 투자 비중 축소 (예: 50%)
  - 주의 문구 표시

### (3) 쿨다운 제한

- 최근 매매 이후 일정 기간(예: 1~3일) 동안 동일 방향 거래 금지
- 잦은 매매로 인한 수수료 손실 방지

### (4) RSI 과매수 차단

- RSI 점수가 임계값 이상인 종목은 신규 매수 차단
- 이미 보유 중인 과매수 종목은 일부 매도 제안

### (5) 데이터 부족 처리

- 가격 데이터가 없거나 불완전한 경우 대기 상태로 복귀
- 현금이 부족할 경우에도 매수 제안 중단

### (6) 비추천 종목 제외

- 추천 유니버스에 없는 티커나 비활성화된 ETF는 자동 제외
- 데이터 품질이 낮은 종목도 제외

### (7) 포트폴리오 포화 처리

- 슬롯이 가득 차 있으면 신규 편입 중단
- 교체 가능한 후보만 표시

---

## 6. 데이터 사용 및 일관성

### (1) 추천/백테스트 데이터 일관성

시스템은 **추천과 백테스트가 동일한 로직과 데이터를 사용**하도록 설계되었습니다.

#### 데이터 기준

- **모든 워크플로우 동일**: 추천, 백테스트, 튜닝 모두 **최근 마감된 거래일의 종가**까지만 사용
- **실시간 데이터 미사용**: 의사결정에 장중 가격이나 실시간 데이터를 사용하지 않음
- **재현성 보장**: 같은 날짜, 같은 설정이면 항상 동일한 결과 생성

#### 예시

```
2025-10-30(수) 추천 실행:
- 사용 데이터: 2025-10-29(화) 종가까지
- 07:00 실행 = 09:00 실행 = 15:00 실행 → 동일한 추천

2025-10-30(수) 백테스트:
- 사용 데이터: 2025-10-29(화) 종가까지
- 추천과 완전히 동일한 로직 및 데이터
```

### (2) 정보성 실시간 데이터

**화면 표시용으로만** 실시간 정보를 제공합니다:

- **현재가**: 네이버/yfinance API를 통한 실시간 가격 조회
- **NAV**: 한국 ETF의 순자산가치 (참고용)
- **괴리율**: 시장가격과 NAV의 차이 (참고용)

**중요**: 이 정보는 **매매 의사결정에 영향을 주지 않으며**, 순수하게 사용자 정보 제공 목적입니다.

### (3) 시장 거래 시간표

국가별 시장 거래 시간 (한국 시간 기준):

| 국가 | 개장 | 마감 | 체크 간격 |
|------|------|------|----------|
| 한국 | 09:00 | 16:00 | 20분 |

이 시간표는 정보성 데이터 조회 스케줄링에만 사용되며, 매매 의사결정과는 무관합니다.

---

## 7. 수익률 측정 방식

시스템은 세 가지 방식으로 성과를 측정하고 비교합니다:

### (1) 백테스트 (Backtest)

**목적**: 과거 데이터로 전략 검증 및 파라미터 최적화

**거래 조건**:

- **가격**: 다음날 시초가 (실제 체결 가능성 반영)
- **슬리피지**: 매수 +0.25%, 매도 -0.25%
- **리밸런싱**: 없음 (일별 매매 로직만 수행)

**특징**:

- 실제 거래보다 불리한 조건 (보수적 추정)
- 전략 파라미터(MA 기간, 포트폴리오 크기 등) 최적화에 사용
- 과거 성과를 통해 전략의 유효성 검증

### (2) 벤치마크 비교 (Buy & Hold)

**목적**: 단순 보유 전략 대비 성과 비교

**거래 조건**:

- **가격**: 시작일 종가 → 최신 거래일 종가
- **슬리피지**: 없음
- **리밸런싱**: 없음 (매수 후 보유만)

**특징**:

- 전통적인 Buy & Hold 전략
- Momentum ETF 전략의 우수성 입증 기준
- 대표 ETF(KODEX 200, SPY, QQQ 등)와 비교

### 비교 요약

| 구분 | 백테스트 | 벤치마크 |
|------|---------|---------|
| **가격** | 다음날 시초가 | 시작일 종가 → 최신 종가 |
| **슬리피지** | 있음 (0.25~0.5%) | 없음 |
| **리밸런싱** | 없음 (일별 시뮬레이션 내 거래만 수행) | 없음 |
| **목적** | 전략 검증 | 비교 기준 |

> **참고**: 추천/백테스트 모두 하루 단위 매매 로직만 수행하며, 주간 균등 비중 리밸런싱은 더 이상 사용하지 않습니다.

---

## 7. 전략 파라미터

시스템은 다음 파라미터를 사용하여 최적화됩니다:

| 파라미터 | 설명 | 일반적 범위 |
|---------|------|-----------|
| **MA_PERIOD** | 이동평균 기간 | 10~100일 |
| **MA_TYPE** | 이동평균 타입 | SMA, EMA, HMA 등 |
| **PORTFOLIO_TOPN** | 포트폴리오 목표 종목 수 | 3~10개 |
| **REPLACE_SCORE_THRESHOLD** | 교체 점수 임계값 | 0~3점 |
| **OVERBOUGHT_SELL_THRESHOLD** | RSI 과매수 임계값 | 5~30점 |
| **COOLDOWN_DAYS** | 쿨다운 기간 | 0~5일 |
| **CORE_HOLDINGS** | 핵심 보유 종목 | 티커 리스트 |

이 파라미터들은 **최적화(Optimization)** 과정을 통해 최적값을 찾습니다.

**참고:** 시장 레짐 필터는 대시보드에서 참고용으로만 사용되며, 실제 매매에는 영향을 주지 않습니다 (항상 100% 투자).

---

## 8. 결론

ETF 추천 시스템은
**"지속적인 상승 추세를 유지하면서 시장 위험을 피하는 종목만 선별"**하는
**반(半)자동 포트폴리오 운용 시스템**입니다.

> 이 시스템은 사용자가 직접 시장을 모니터링하지 않아도,
> 상승 종목 유지 / 교체 / 매도 시점을 자동으로 제시해
> 투자 효율성과 안정성을 동시에 제공합니다.

### 핵심 강점

1. **데이터 기반 의사결정**: 감정이 아닌 수치로 판단
2. **리스크 관리**: 시장 레짐, RSI, 카테고리 중복 등 다층 방어
3. **자동화**: 매일 추천 업데이트, 수동 개입 최소화
4. **투명성**: 모든 판단 근거와 수익률을 명확히 제시
5. **검증 가능성**: 백테스트로 전략 유효성 입증

### 사용 시 유의사항

- 시스템은 **보조 도구**이며, 최종 투자 결정은 사용자의 판단입니다.
- 과거 성과가 미래 수익을 보장하지 않습니다.
- 시장 급변 시 시스템 반응에 시차가 있을 수 있습니다.
- 정기적으로 파라미터를 재튜닝하여 시장 변화에 대응하세요.
