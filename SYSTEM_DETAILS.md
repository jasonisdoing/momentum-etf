# ETF 추천 시스템 상세 매뉴얼

## 1. 시스템 개요
이 시스템은 여러 ETF의 가격 흐름을 분석해 **최근 상승 추세가 강한 종목을 자동으로 추천**합니다.
이동평균(MA) 대비 현재 가격 위치, 최근 1~3주의 수익률, 연속 상승 일수 등을 종합적으로 반영해
ETF별 '상승 강도 점수'를 계산합니다.

---

## 2. 작동 원리

### (1) 추세 분석 (MAPS 전략)
- 각 ETF의 현재 가격이 이동평균선 위에 얼마나 위치하는지 측정합니다.
- 최근 1·2·3주 수익률, 연속 상승 일수 등을 함께 반영해 종합 점수를 계산합니다.
- 점수가 높을수록 상승 추세가 뚜렷한 ETF로 간주합니다.

### (2) RSI 과매수 감지
- RSI(Relative Strength Index) 지표로 과열 종목을 감지합니다.
- RSI 점수가 임계값 이하로 떨어지면 과매수 상태로 판단합니다.
- 과매수 종목은 자동으로 일부 매도하거나 신규 매수를 차단합니다.

### (3) 추천 절차
1. 투자 가능한 ETF 후보군을 생성합니다.
2. 각 ETF의 MAPS 점수와 RSI 점수를 계산합니다.
3. 점수를 종합해 상위권 ETF를 추천합니다.
4. 보유 중인 ETF라도 점수가 낮으면, 더 높은 점수를 가진 후보로 교체합니다.
5. 포트폴리오 여유가 있을 때는 신규 편입을 제안하고,
   여유가 없으면 기존 종목과 점수 차가 충분히 클 때만 교체합니다.
6. ETF 가격이 이동평균선 아래로 떨어지거나 RSI 과매수 상태면 매도 신호로 판단합니다.

---

## 3. 시장 상황 반영 (Market Regime)
시장의 전반적인 리스크 신호를 실시간 감시합니다.

### 시장 레짐 판단 기준
- **주요 지수**(S&P 500, NASDAQ 등)의 가격이 이동평균선 대비 어디에 위치하는지 확인
- 이동평균선 아래로 떨어지면 "시장 위험" 신호 발생

### 시장 상황별 대응
- **시장이 불안하거나 하락세로 전환될 경우**:
  - 신규 매수를 중단하거나 투자 비중을 축소합니다 (예: 현금의 50%만 투자)
  - 경고 문구를 표시합니다.
  
- **시장이 안정적일 경우**:
  - 상승세 ETF를 유지하거나 추가 편입합니다.
  - 정상 투자 비중(100%)으로 운영합니다.

이를 통해 **개별 ETF의 추세**뿐만 아니라 **시장 전체 상황(레짐)** 도 함께 고려합니다.

---

## 4. 포지션 상태 로직
각 ETF는 시스템 내부에서 다음과 같은 상태를 가집니다.

| 상태 | 설명 |
|------|------|
| **WAIT** | 기본 대기 상태. 조건 미충족 또는 제약 발생. |
| **BUY** | 신규 매수 제안. 상승세 뚜렷, 리스크 낮음. |
| **HOLD** | 보유 유지. 여전히 상승세 유지 중. |
| **SELL_TREND** | 이동평균선 아래로 떨어져 추세 약화. 전량 매도 제안. |
| **SELL_TRIM** | RSI 과매수 상태. 일부 매도 제안 (보유 비중 축소). |
| **CUT_STOPLOSS** | 손실률이 설정 한도를 초과해 손절 지시. |
| **SELL_REPLACE** | 교체 대상 선정 시 기존 종목 매도. |
| **BUY_REPLACE** | 교체 대상 선정 시 신규 종목 편입. |

### 매수 예산 계산
매수 예산은 다음 공식으로 계산됩니다:
```
매수 예산 = min(
    현재 총자산 / 포트폴리오 목표 종목 수,
    보유 현금
)
```

이를 통해 **비중 과다 투자**를 방지하고 균등 분배를 유지합니다.

---

## 5. 리스크 및 제약 조건

### (1) 카테고리 중복 방지
- 동일 카테고리(섹터) ETF가 이미 포트폴리오에 있으면 WAIT 상태로 유지
- 예: 기술주 ETF를 이미 보유 중이면 다른 기술주 ETF는 편입 불가

### (2) 시장 레짐 리스크 오프
- 전체 시장 리스크가 높을 시:
  - 신규 매수 차단 또는 투자 비중 축소 (예: 50%)
  - 주의 문구 표시

### (3) 쿨다운 제한
- 최근 매매 이후 일정 기간(예: 1~3일) 동안 동일 방향 거래 금지
- 잦은 매매로 인한 수수료 손실 방지

### (4) RSI 과매수 차단
- RSI 점수가 임계값 이하인 종목은 신규 매수 차단
- 이미 보유 중인 과매수 종목은 일부 매도 제안

### (5) 데이터 부족 처리
- 가격 데이터가 없거나 불완전한 경우 대기 상태로 복귀
- 현금이 부족할 경우에도 매수 제안 중단

### (6) 비추천 종목 제외
- 추천 유니버스에 없는 티커나 비활성화된 ETF는 자동 제외
- 데이터 품질이 낮은 종목도 제외

### (7) 포트폴리오 포화 처리
- 슬롯이 가득 차 있으면 신규 편입 중단
- 교체 가능한 후보만 표시

---

## 6. 수익률 측정 방식

시스템은 세 가지 방식으로 성과를 측정하고 비교합니다:

### (1) 백테스트 (Backtest)
**목적**: 과거 데이터로 전략 검증 및 파라미터 최적화

**거래 조건**:
- **가격**: 다음날 시초가 (실제 체결 가능성 반영)
- **슬리피지**: 
  - 한국: 매수 +0.5%, 매도 -0.5%
  - 호주: 매수 +1.0%, 매도 -1.0%
  - 미국: 매수 +0.3%, 매도 -0.3%
- **리밸런싱**: 포트폴리오 목표 종목 수 기준 균등 분배

**특징**:
- 실제 거래보다 불리한 조건 (보수적 추정)
- 전략 파라미터(MA 기간, 포트폴리오 크기 등) 최적화에 사용
- 과거 성과를 통해 전략의 유효성 검증

### (2) 실제 거래 수익률 (Momentum ETF Performance)
**목적**: 실제 투자 성과 측정

**거래 조건**:
- **가격**: 거래일 종가 (실제 체결 가능)
- **슬리피지**: 없음 (벤치마크와 동일 조건)
- **리밸런싱**: 동적 균등 분배
  - 같은 날 여러 거래 발생 시, 최종 보유 종목 수 기준으로 자산 재분배
  - 예: 2개 보유 + 3개 매수 → 5개 종목으로 균등 분배

**특징**:
- 실제 거래 내역 기반 계산
- 공정한 비교를 위해 슬리피지 제거
- 동적 리밸런싱으로 포트폴리오 균형 유지

### (3) 벤치마크 비교 (Buy & Hold)
**목적**: 단순 보유 전략 대비 성과 비교

**거래 조건**:
- **가격**: 시작일 종가 → 최신 거래일 종가
- **슬리피지**: 없음
- **리밸런싱**: 없음 (매수 후 보유만)

**특징**:
- 전통적인 Buy & Hold 전략
- Momentum ETF 전략의 우수성 입증 기준
- 대표 ETF(KODEX 200, SPY, QQQ 등)와 비교

### 비교 요약

| 구분 | 백테스트 | Momentum ETF | 벤치마크 |
|------|---------|-------------|---------|
| **가격** | 다음날 시초가 | 당일 종가 | 시작일 종가 → 최신 종가 |
| **슬리피지** | 있음 (0.3~1%) | 없음 | 없음 |
| **리밸런싱** | 균등 분배 | 동적 균등 분배 | 없음 |
| **목적** | 전략 검증 | 실제 성과 | 비교 기준 |

---

## 7. 전략 파라미터

시스템은 다음 파라미터를 사용하여 최적화됩니다:

| 파라미터 | 설명 | 일반적 범위 |
|---------|------|-----------|
| **MA_PERIOD** | 이동평균 기간 | 10~100일 |
| **PORTFOLIO_TOPN** | 포트폴리오 목표 종목 수 | 3~10개 |
| **REPLACE_SCORE_THRESHOLD** | 교체 점수 임계값 | 0~3점 |
| **OVERBOUGHT_SELL_THRESHOLD** | RSI 과매수 임계값 | 5~30점 |
| **COOLDOWN_DAYS** | 쿨다운 기간 | 0~5일 |
| **MARKET_REGIME_MA** | 시장 레짐 MA 기간 | 10~100일 |
| **MARKET_REGIME_RISK_OFF_EQUITY_RATIO** | 위험 시 투자 비중 | 0~100% |

이 파라미터들은 **튜닝(Tuning)** 과정을 통해 최적값을 찾습니다.

---

## 8. 결론
ETF 추천 시스템은
**"지속적인 상승 추세를 유지하면서 시장 위험을 피하는 종목만 선별"**하는
**반(半)자동 포트폴리오 운용 시스템**입니다.

> 이 시스템은 사용자가 직접 시장을 모니터링하지 않아도,
> 상승 종목 유지 / 교체 / 매도 시점을 자동으로 제시해
> 투자 효율성과 안정성을 동시에 제공합니다.

### 핵심 강점
1. **데이터 기반 의사결정**: 감정이 아닌 수치로 판단
2. **리스크 관리**: 시장 레짐, RSI, 카테고리 중복 등 다층 방어
3. **자동화**: 매일 추천 업데이트, 수동 개입 최소화
4. **투명성**: 모든 판단 근거와 수익률을 명확히 제시
5. **검증 가능성**: 백테스트로 전략 유효성 입증

### 사용 시 유의사항
- 시스템은 **보조 도구**이며, 최종 투자 결정은 사용자의 판단입니다.
- 과거 성과가 미래 수익을 보장하지 않습니다.
- 시장 급변 시 시스템 반응에 시차가 있을 수 있습니다.
- 정기적으로 파라미터를 재튜닝하여 시장 변화에 대응하세요.
