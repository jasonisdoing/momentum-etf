# 전략 로직 상세 (Strategy Logic)

이 문서는 Momentum ETF 시스템의 핵심 매매 알고리즘과 로직을 상세히 설명합니다.

## 1. 5버킷 포트폴리오 할당 (5-Bucket Allocation)

시스템은 자산을 다음 5가지 버킷(Bucket)으로 나누어 배분합니다. 각 버킷은 고유한 역할을 가지며 서로 다른 시장 상황에 대응합니다.

1.  **모멘텀 (Momentum)**: 가장 강한 상승 추세를 보이는 ETF. 공격적인 수익 추구.
2.  **혁신기술 (Innovation)**: 기술주, 성장주 위주의 ETF.
3.  **시장지수 (Market Index)**: S&P500, 나스닥 등 시장 대표 지수. 안정적인 베이스.
4.  **배당방어 (Dividend/Defensive)**: 고배당주, 리츠 등 하락장 방어 및 현금 흐름 창출.
5.  **대체헷지 (Alternative/Hedge)**: 금, 원자재, 채권 등 주식과의 상관관계가 낮은 자산.

### 버킷 내 종목 선정 (Selection)
각 버킷별로 등록된 ETF 후보군 중에서 **MAPS 점수**가 가장 높은 상위 종목(`BUCKET_TOPN`)을 선별하여 투자합니다.

## 2. 추세 분석 알고리즘 (MAPS)

시스템은 각 ETF의 상승 강도를 평가하기 위해 **MAPS (Moving Average Position Score)** 전략을 사용합니다.

### 평가 요소
1.  **이동평균(MA) 위치**: 현재 가격이 이동평균선 위에 있는가? (가장 큰 비중)
2.  **단기 수익률**: 최근 1주, 2주, 3주간의 수익률 추이
3.  **연속 상승**: 최근 며칠간 연속으로 상승했는가?

이 요소들을 종합하여 각 ETF에 점수를 부여하며, 점수가 높을수록 상승 추세가 강한 것으로 판단합니다. (점수의 양수/음수 여부와 무관하게 모든 후보 종목의 상대적 순위를 비교하여 매매를 결정합니다.)

## 2. 포지션 상태 및 결정 로직

각 ETF는 매일 다음 중 하나의 상태를 가집니다.

| 상태 | 설명 |
|------|------|
| **WAIT** | 관망. 매수 조건 미충족 또는 쿨다운 중. |
| **BUY** | 신규 매수. 상승 추세가 확인되고 리스크가 낮은 상태. |
| **HOLD** | 보유. 상승 추세가 유지되고 있음. |
| **SELL_TREND** | 매도. 가격이 이동평균선 아래로 하락하여 추세가 꺾임. |
| **SELL_RSI** | 매도. RSI 지표가 과열권에 진입함. |
| **CUT_STOPLOSS** | 손절. 손실률이 설정된 한계(`STOP_LOSS_PCT`)를 초과함. |
| **BUY_REPLACE** | 교체 매수. 보유 종목보다 월등히 좋은 종목이 나타남. |
| **SELL_REPLACE** | 교체 매도. 더 좋은 종목으로 갈아타기 위해 기존 종목 매도. |

### 매도 우선순위
매도 신호가 동시에 발생할 경우 다음 순서로 처리합니다:
1.  **CUT_STOPLOSS** (가장 시급)
2.  **SELL_RSI**
3.  **SELL_TREND**

## 3. 리스크 관리 규칙

### (1) 쿨다운 (Cooldown)
잦은 매매로 인한 손실을 방지하기 위해 매매 후 일정 기간 거래를 제한합니다.
*   **매수 쿨다운**: 매도 후 `COOLDOWN_DAYS` 동안 재매수 금지
*   **매도 쿨다운**: 매수 후 `COOLDOWN_DAYS` 동안 매도 금지
*   **예외**: **손절(CUT_STOPLOSS)**은 쿨다운을 무시하고 즉시 매도합니다.



### (2) RSI 과매수 차단
*   RSI 점수가 `OVERBOUGHT_SELL_THRESHOLD`를 초과하면 **과매수**로 판단합니다.
*   보유 중인 종목은 매도 신호(`SELL_RSI`)가 발생합니다.
*   신규 매수 후보라도 과매수 상태라면 매수가 차단됩니다.



### (3) 교체 매매 (Replacement) 로직
*   보유 종목보다 훨씬 더 강력한 상승 추세를 보이는 새로운 종목이 나타나면 교체 매매를 수행합니다.
*   **조건**: `신규 종목 점수 > 보유 종목 점수 + REPLACE_SCORE_THRESHOLD`
*   **순차적 탐색 (Iterative Search)**:
    1.  보유 종목 중 **점수가 가장 낮은 종목부터 순서대로** 비교합니다.
    2.  비교 대상 종목이 **쿨다운(Cooldown)** 상태라면 교체할 수 없으므로 건너뛰고 **다음으로 점수가 낮은 종목**을 탐색합니다.
    3.  즉, 가장 약한 종목이 쿨다운이라도 포기하지 않고, 그 다음 약한 종목을 찾아 교체 기회를 모색합니다.

## 4. 리밸런싱 주기 (Rebalance Mode)

전략의 매매 주기를 설정하여 불필요한 거래 비용을 절감합니다.

*   **DAILY** (일간): 매일 매수/교체 조건을 확인하고 매매를 실행합니다.
*   **MONTHLY** (월간): 매월 첫 거래일에만 신규 매수 및 교체 매매를 수행합니다.
*   **QUARTERLY** (분기): 매 분기(1, 4, 7, 10월) 첫 거래일에만 신규 매수 및 교체 매매를 수행합니다. (5버킷 전략 권장 정석)
*   **주의**: **손절(CUT_STOPLOSS)** 및 **RSI 매도(SELL_RSI)**와 같은 보호적 매도는 리밸런싱 주기와 관계없이 **매일 실행**됩니다.

## 4. 매매 가격 및 정합성 (Execution & Consistency)

시스템은 백테스트와 추천 모두 **동일한 시뮬레이션 엔진**을 사용하므로 완벽한 논리적 정합성을 유지합니다.

*   **매수/매도 시점**: 신호 발생 **다음날 장 시작(Open) 시점**
*   **체결 가격**:
    *   **백테스트**: `다음날 시초가 * (1 + 슬리피지)` 로 계산 (매수 시 +슬리피지, 매도 시 -슬리피지)
    *   **추천 요약 표**: **모든 보유 종목**의 평가 수익률은 백테스트와의 정합성을 위해  **`매수일자 시초가 * (1 + 슬리피지)`**를 이론적 진입가로 가정하여 계산하고 표시합니다.
    *   **실제 매매**: 사용자는 추천 알림을 받은 **다음날 아침 장 시작 시점**에 시초가 부근에서 매매하는 것을 권장합니다.

## 5. 파라미터 튜닝 (Top 3 Ensemble)

시장 상황에 맞는 최적의 파라미터를 찾기 위해 백테스트 기반의 튜닝을 수행합니다. `python tune.py <account>` 실행 시 **최적 파라미터가 자동으로 계정 설정 파일에 반영**됩니다.


과적합을 피하기 위해 **상위 3~5개 조합의 앙상블** 방식을 사용합니다.

1.  **MA_MONTH (이동평균 기간, 개월)**: 상위 3개 결과의 **평균값(Average)**을 사용 (반올림)
2.  **기타 파라미터**: 상위 3개 결과의 **최빈값(Mode)**을 사용. (모두 다르면 1위 값 사용)

### 주요 전략 파라미터 (필수 설정)
*   `MA_MONTH`: 이동평균 기간 (예: 3개월, 6개월, 12개월)
*   `BUCKET_TOPN`: 버켓 내 최대 보유 종목 수
*   `REPLACE_SCORE_THRESHOLD`: 교체 매매를 위한 점수 차이 기준
*   `OVERBOUGHT_SELL_THRESHOLD`: RSI 과매수 기준값
*   `REBALANCE_MODE`: 리밸런싱 주기 (`DAILY`, `MONTHLY`, `QUARTERLY`)
*   `STOP_LOSS_PCT`: 개별 종목 손절 기준 (%)
