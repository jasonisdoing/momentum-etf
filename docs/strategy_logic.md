# 전략 로직 상세 (Strategy Logic)

이 문서는 Momentum ETF 시스템의 핵심 매매 알고리즘과 로직을 상세히 설명합니다.

## 1. 추세 분석 알고리즘 (MAPS)

시스템은 각 ETF의 상승 강도를 평가하기 위해 **MAPS (Moving Average Position Score)** 전략을 사용합니다.

### 평가 요소
1.  **이동평균(MA) 위치**: 현재 가격이 이동평균선 위에 있는가? (가장 큰 비중)
2.  **단기 수익률**: 최근 1주, 2주, 3주간의 수익률 추이
3.  **연속 상승**: 최근 며칠간 연속으로 상승했는가?

이 요소들을 종합하여 각 ETF에 점수를 부여하며, 점수가 높을수록 상승 추세가 강한 것으로 판단합니다.

## 2. 포지션 상태 및 결정 로직

각 ETF는 매일 다음 중 하나의 상태를 가집니다.

| 상태 | 설명 |
|------|------|
| **WAIT** | 관망. 매수 조건 미충족 또는 쿨다운 중. |
| **BUY** | 신규 매수. 상승 추세가 확인되고 리스크가 낮은 상태. |
| **HOLD** | 보유. 상승 추세가 유지되고 있음. |
| **SELL_TREND** | 매도. 가격이 이동평균선 아래로 하락하여 추세가 꺾임. |
| **SELL_RSI** | 매도. RSI 지표가 과열권에 진입함. |
| **CUT_STOPLOSS** | 손절. 손실률이 설정된 한계(`STOP_LOSS_PCT`)를 초과함. |
| **BUY_REPLACE** | 교체 매수. 보유 종목보다 월등히 좋은 종목이 나타남. |
| **SELL_REPLACE** | 교체 매도. 더 좋은 종목으로 갈아타기 위해 기존 종목 매도. |

### 매도 우선순위
매도 신호가 동시에 발생할 경우 다음 순서로 처리합니다:
1.  **CUT_STOPLOSS** (가장 시급)
2.  **SELL_RSI**
3.  **SELL_TREND**

## 3. 리스크 관리 규칙

### (1) 쿨다운 (Cooldown)
잦은 매매로 인한 손실을 방지하기 위해 매매 후 일정 기간 거래를 제한합니다.
*   **매수 쿨다운**: 매도 후 `COOLDOWN_DAYS` 동안 재매수 금지
*   **매도 쿨다운**: 매수 후 `COOLDOWN_DAYS` 동안 매도 금지
*   **예외**: **손절(CUT_STOPLOSS)**은 쿨다운을 무시하고 즉시 매도합니다.

### (2) RSI 과매수 차단
*   RSI 점수가 `OVERBOUGHT_SELL_THRESHOLD`를 초과하면 **과매수**로 판단합니다.
*   보유 중인 종목은 매도 신호(`SELL_RSI`)가 발생합니다.
*   신규 매수 후보라도 과매수 상태라면 매수가 차단됩니다.

### (3) 카테고리 중복 제한
*   동일한 섹터(카테고리)의 ETF는 포트폴리오에 중복해서 담지 않습니다.
*   예: 이미 '기술주' ETF를 보유 중이라면, 점수가 높은 다른 '기술주' ETF가 있어도 매수하지 않습니다.
*   **예외**: `config.CATEGORY_EXCEPTIONS`에 등록된 카테고리는 중복 허용됩니다.

## 4. 파라미터 튜닝 (Top 3 Ensemble)

시장 상황에 맞는 최적의 파라미터를 찾기 위해 백테스트 기반의 튜닝을 수행합니다. 과적합을 피하기 위해 **상위 3개 조합의 앙상블** 방식을 사용합니다.

1.  **MA_PERIOD (이동평균 기간)**: 상위 3개 결과의 **평균값(Average)**을 사용 (반올림)
2.  **기타 파라미터**: 상위 3개 결과의 **최빈값(Mode)**을 사용. (모두 다르면 1위 값 사용)

### 주요 튜닝 파라미터
*   `MA_PERIOD`: 이동평균 기간 (예: 20일, 60일)
*   `PORTFOLIO_TOPN`: 최대 보유 종목 수
*   `REPLACE_SCORE_THRESHOLD`: 교체 매매를 위한 점수 차이 기준
*   `OVERBOUGHT_SELL_THRESHOLD`: RSI 과매수 기준값
