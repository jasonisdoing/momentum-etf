# DEVELOPMENT_RULES.md

## 1. 기본 원칙

1. **병렬 처리 금지**
    - 모든 데이터와 연산은 **순차적**으로 처리한다.
    - 멀티스레딩/멀티프로세싱은 사용하지 않는다.
    - 단, 튜닝의 경우는 예외한다.

2. **휴장일 처리**
    - 개장일에서 KST 자정이 지나면 다음거래일로 간주한다.
    - 휴장일에는 다음거래일로 간주한다.
    - 휴장일에는 종목들의 가격을 새로 조회하지 말고, 마지막 거래일의 가격이 캐시에 있으면 그대로 사용한다.
    - 휴장일 이후 **다음 거래일 데이터 기준**으로 추천를 생성한다.

3. **전략에 관한 설정**
    - 모든 전략에 관한 설정을 strategies/{전략명} 폴더 내부에 들어가야 한다.
    - 여러 전략 파일이 있으면 그걸 백테스트에서 비교할 수 있어야 한다.

4. **가격 데이터의 소스**
    - 한국은 pykrx에서 어제까지의 데이터가 가능하고, 장개시 이후이후 자정까지는 네이버에서 데이터를 가져온다

5. **종목 Universe 구성**
    - `utils/stock_list_io.get_etfs()` 를 통해 **카테고리별 3개월 수익률( `3_month_earn_rate` )이 가장 높은 1개** ETF만 대표로 선택한다.
    - 카테고리가 `TBD` 인 종목은 필터링하지 않고 모두 포함한다.
    - 각 계좌의 `benchmarks` 값에 있는 티커는 카테고리와 무관하게 항상 추가한다.
    - 추천, 백테스트, 튜닝, 가격 캐시 갱신이 모두 동일한 대표군을 사용해야 한다.

---

## 2. 종목가격 원칙

1. **종목 가격의 저장**
    - 종목들의 가격 정보는 data/cache/{country}/*.pkl 파일에 캐시로 저장되고,
    데이터가 필요하면 그 증분만큼 가져온다.

2. **종목 가격의 소스**
    - 종목 가격은 9시가 개장시간이라면 그 개장 이전에는 전 거래일의 가격을 이용하고,
    개장 시간 이후부터 자정까지는 당일의 가격을 이용한다
    - 휴장일에는 마찬가리고 건 거래일의 가격을 이용한다
    - 단, 한국의 경우는 개장시간 이후부터 자정까지는 네이버 금융에서 실시간 시세를 이용한다.

3. **캐시 유지 관리**
    - `scripts/update_price_cache.py` 는 대표군 티커만 새로 다운로드하며, MongoDB의 임시 컬렉션(`cache_kor_stocks_tmp_*`) 중 **1시간 이상 지난 항목**은 정리한다.

---

## 3. 나중에 수익 관련한 부분을 추가할 예정

---

## 4. 저장 및 기록 원칙

1. **로그 기록**
    - 주요 이벤트는 모두 파일 로그에 기록한다.
    - 로그 레벨:
        - `DEBUG`: 디버그용
        - `INFO`: 정상 처리
        - `WARNING`: 데이터 누락/불완전
        - `ERROR`: 실행 실패 send_verbose_log_to_slack() 를 통해서 에러는 메시지를 보낸다.

---

## 5. 예외 처리 원칙

1. **거래 데이터 부족한 종목**
    - 계산을 할때 필요한 기간의 거래 데이터가 부족한 경우는 계산에서 제외한다.
        - 예) "TIMEFOLIO 미국나스닥100액티브(426030): 데이터 기간이 부족하여 계산에서 제외됩니다."
    - 한국의 경우 pykrx에 데이터가 없는 종목도 실시간 데이터는 추천 화면에 보여줘야 한다.
    - 테스트/튜닝을 할때 필요한 기간의 거래 데이터가 부족한 경우는 해당 종목의 데이터가 있는 구간만 사용한다.

3. **거래 불가능 종목**
    - 거래 정지, 상장폐지 등 종목은 건너뛰고 로그에 남긴다.

4. **비정상 데이터**
    - 음수 가격, 일부 항목이 없는 데이터 등 비정상 값이 있으면 해당 함수 및 전체를 진행하지 않고 ERROR로그를 남긴다

---

## 6. 대시보드 관리 원칙

1. **일간 수익률 기준**
    - 거래일 개장시간 이후 자정까지는 그날의 추천에서 가져온 수익률을 보여준다.
    - 휴장일의 수익률은 0%로 보여준다.
    - 거래일 개장시간 이전은 0%로 보여준다.

---

## 7. 코드 생성/관리 원칙

1. **AI 코드 생성 시 지침**
    - 함수, 클래스 단위로 모듈화 (1파일 1기능 원칙)
    - 중복 코드 발견 시 리팩터링 제안
    - 사용하지 않는 import, 펑션 모두 제거
    - 변경한 모든 파일을 flake8 실행해서 문제 되는 부분을 바로 수정한다.

---

## 8. 확장 원칙

1. 새로운 전략이나 지표를 추가할 때는 **본 문서의 규칙을 우선 준수**한다.
2. 규칙과 충돌하는 새로운 로직이 필요하다면, 반드시 본 문서를 업데이트한 뒤 적용한다.
