# 개발자 가이드 (Developer Guide)

이 문서는 Momentum ETF 시스템의 아키텍처, 데이터 흐름, 그리고 개발 시 반드시 지켜야 할 정합성 원칙을 설명합니다.

## 1. 시스템 아키텍처

### 모듈 구조
*   `recommend.py`: 백테스트 엔진을 호출하여 가장 최신일(오늘)의 시뮬레이션 결과를 추출하고 추천 리포트를 생성하는 엔트리 포인트
*   `core/backtest/`: 핵심 시뮬레이션 엔진 및 계좌별 백테스트 실행 로직
*   `scripts/`: 데이터 수집, 캐시 갱신 등 유틸리티 스크립트
*   `utils/`:
    *   `cache_utils.py`: **Parquet 기반 캐시 I/O** 및 직렬화 관리
    *   `ui.py`: Streamlit 커스텀 컴포넌트 및 스타일링
*   `.github/workflows/`: GitHub Actions를 이용한 일일 배포 및 자동화 정의

### 데이터 파이프라인 및 캐싱
1.  **데이터 수집**: `pykrx`, `yfinance` 등을 통해 원천 데이터 수집.
2.  **Parquet 캐싱**: 수집된 데이터는 `utils/cache_utils.py`를 통해 **Apache Parquet** 포맷으로 MongoDB에 저장됩니다. (기존 Pickle 방식의 버전 충돌 문제를 해결)
3.  **시뮬레이션**: 백테스트 엔진이 캐시된 데이터를 로드하여 전략 시뮬레이션 수행.
4.  **추천 생성**: 시뮬레이션의 마지막 날 상태를 스냅샷으로 추출.

## 2. 추천/백테스트 정합성 원칙

> **Critical**: 이 시스템에서 **추천(Recommend)은 백테스트(Backtest) 시뮬레이션의 마지막 결과**입니다. 두 로직은 물리적으로 하나로 통합되어 있어 완벽한 정합성을 보장합니다.

### 핵심 구조
| 파일/경로 | 역할 |
|-----------------|------|
| `recommend.py` | `backtest.py`의 핵심 로직을 호출하여 최신 권장 사항 추출 및 리포트(Slack, JSON, DB) 생성 |
| `backtest.py` | 단일 계정 또는 전체 기간에 대한 전략 시뮬레이션 실행 |
| `logic/backtest/account.py` | 개별 계좌의 상태(현금, 보유종목, 수익률)를 관리하는 핵심 엔진 |

### 핵심 일관성 체크리스트

1.  **리밸런싱 주기 엄수**: 매수/매도/교체는 오직 **리밸런싱 날(Rebalance Day)**에만 발생해야 한다.
2.  **데이터 기준**:
    *   모든 의사결정은 **판단 시점의 전일 종가 데이터**를 기준으로 함
    *   추천 리포트 생성 시, "오늘"의 신호는 "어제까지의 마감 데이터"를 보고 결정된 것임
3.  **엄격한 설정 원칙 (Rule 7)**:
    *   코드에 암묵적인 기본값(fallback)을 사용하지 않습니다.
    *   필수 전략 파라미터가 누락된 경우 명확한 `ValueError`를 발생시켜 의도치 않은 전략 실행을 방지합니다.

## 3. 공통 모듈 (`logic/common/`)

로직의 중복을 피하고 일관성을 유지하기 위해 백테스트 엔진은 다음 공통 모듈을 사용합니다.

*   `portfolio.py`: 보유 수 계산, 매수 필터링
*   `signals.py`: 매수 시그널 발생 여부, 연속 상승일 계산
*   `filtering.py`: 후보군 필터링 및 정렬
*   `price.py`: 가격 결정 및 수익률 계산 로직

## 4. 테스트 및 검증

코드를 수정할 때는 다음 절차를 따르세요.

1.  **로직 수정**: `core/backtest/` 수정
2.  **검증**:
    *   **백테스트 실행**: `python backtest.py <account_id>`를 통해 전체 기간 수익률 추이 및 거래 횟수 확인
    *   **추천 실행**: `python recommend.py <account_id>`를 실행하여 마지막 날 결과가 의도대로 나오는지 확인
3.  **확인**:
    *   `zaccounts/<account_id>/results/` 폴더 내의 로그 파일들을 대조하여 정합성 확인

## 5. 추천 시스템의 정의 (Definition of Recommendation)

**"추천(Recommendation)"**은 계좌의 현재 상태를 기반으로 백테스트 엔진이 내리는 **최신 시뮬레이션 결과**입니다.

### 핵심 원칙
1.  **백테스트 기반**: 추천 로직은 백테스트와 별개가 아닙니다. 백테스트를 실행했을 때 마지막 날 발생하는 액션이 곧 추천입니다.
2.  **자산 상태 반영**: 추천은 단순한 시그널 목록이 아니라, 해당 계좌의 **현재 현금 비중과 보유 종목 수**를 고려하여 생성됩니다. (예: 현금이 부족하거나 슬롯이 가득 차면 매수 신호가 발생해도 `WAIT` 상태가 될 수 있습니다.)
