# 개발자 가이드 (Developer Guide)

이 문서는 Momentum ETF 시스템의 아키텍처, 데이터 흐름, 그리고 개발 시 반드시 지켜야 할 정합성 원칙을 설명합니다.

## 1. 시스템 아키텍처

### 모듈 구조
*   `recommend.py`: 백테스트 엔진을 호출하여 가장 최신일(오늘)의 시뮬레이션 결과를 추출하고 추천 리포트를 생성하는 엔트리 포인트
*   `logic/backtest/`:
    *   `engine.py`: 핵심 시뮬레이션 엔진 (매매 실행, 시간 순차 처리)
    *   `portfolio.py`: 포트폴리오 상태 관리 및 도메인 로직 (종목 카운트, 필터링 등)
    *   그 외 `filtering.py`, `signals.py` 등 공통 유틸리티
*   `logic/tune/`: 파라미터 최적화 로직
*   `utils/`: 데이터 I/O, 로깅, UI 렌더링 등 유틸리티

### 데이터 파이프라인
1.  **데이터 수집**: `pykrx`, `yfinance`, 네이버 금융 등을 통해 일별 OHLCV 및 INAV 데이터 수집
2.  **전처리**: 수정주가 반영, 결측치 처리
3.  **시뮬레이션 (Backtest Engine)**: 과거 데이터부터 현재까지 전략 로직에 따라 매매를 시뮬레이션
4.  **추천 생성**: 시뮬레이션의 마지막 날(오늘) 상태를 스냅샷으로 추출하여 추천 신호 생성

## 2. 추천/백테스트 정합성 원칙

> **Critical**: 이 시스템에서 **추천(Recommend)은 백테스트(Backtest) 시뮬레이션의 마지막 결과**입니다. 두 로직은 물리적으로 하나로 통합되어 있어 완벽한 정합성을 보장합니다.

### 핵심 구조
| 파일/경로 | 역할 |
|-----------------|------|
| `recommend.py` | `backtest.py`의 핵심 로직을 호출하여 최신 권장 사항 추출 및 리포트(Slack, JSON, DB) 생성 |
| `backtest.py` | 단일 계정 또는 전체 기간에 대한 전략 시뮬레이션 실행 |
| `logic/backtest/account.py` | 개별 계좌의 상태(현금, 보유종목, 수익률)를 관리하는 핵심 엔진 |

### 핵심 일관성 체크리스트

1.  **매도 조건 우선순위**: `CUT_STOPLOSS` → `SELL_RSI` → `SELL_TREND` 순서를 엄수할 것.
2.  **쿨다운 로직**:
    *   매수 쿨다운: 매도 후 `COOLDOWN_DAYS` 동안 재매수 금지
    *   매도 쿨다운: 매수 후 `COOLDOWN_DAYS` 동안 매도 금지 (단, 손절은 예외)
3.  **RSI 과매수 차단**:
    *   과매수 종목은 신규 매수 금지
    *   보유 종목이 과매수 상태면 해당 카테고리 전체 매수 차단
4.  **핵심 보유 종목 (Core Holdings)**:
    *   모든 매도 신호 무시
    *   미보유 시 최우선 순위로 자동 매수
5.  **데이터 기준**:
    *   모든 의사결정은 **판단 시점의 전일 종가 데이터**를 기준으로 함
    *   추천 리포트 생성 시, "오늘"의 신호는 "어제까지의 마감 데이터"를 보고 결정된 것임

## 3. 공통 모듈 (`logic/common/`)

로직의 중복을 피하고 일관성을 유지하기 위해 백테스트 엔진은 다음 공통 모듈을 사용합니다.

*   `portfolio.py`: 카테고리 중복 체크, 핵심 보유 종목 검증, 보유 수 계산
*   `signals.py`: 매수 시그널 발생 여부, 연속 상승일 계산
*   `filtering.py`: 후보군 필터링 및 정렬
*   `price.py`: 가격 결정 및 수익률 계산 로직

## 4. 테스트 및 검증

코드를 수정할 때는 다음 절차를 따르세요.

1.  **로직 수정**: `logic/backtest/` 수정
2.  **검증**:
    *   **백테스트 실행**: `python backtest.py <account_id>`를 통해 전체 기간 수익률 추이 확인
    *   **추천 실행**: `python recommend.py <account_id>`를 실행하여 마지막 날 결과가 의도대로 나오는지 확인
3.  **확인**:
    *   `zaccounts/<account_id>/results/` 폴더 내의 로그 파일들을 대조하여 정합성 확인

## 5. 추천 시스템의 정의 (Definition of Recommendation)

**"추천(Recommendation)"**은 계좌의 현재 상태를 기반으로 백테스트 엔진이 내리는 **최신 시뮬레이션 결과**입니다.

### 핵심 원칙
1.  **백테스트 기반**: 추천 로직은 백테스트와 별개가 아닙니다. 백테스트를 실행했을 때 마지막 날 발생하는 액션이 곧 추천입니다.
2.  **자산 상태 반영**: 추천은 단순한 시그널 목록이 아니라, 해당 계좌의 **현재 현금 비중과 보유 종목 수**를 고려하여 생성됩니다. (예: 현금이 부족하거나 슬롯이 가득 차면 매수 신호가 발생해도 `WAIT` 상태가 될 수 있습니다.)
