# 핵심 보유 종목 (Core Holdings) 기능

## 개요

핵심 보유 종목 기능은 특정 ETF를 포트폴리오에서 **강제로 보유**하도록 하는 기능입니다. 이 종목들은 매도 신호가 발생해도 매도되지 않으며, 미보유 시 자동으로 매수됩니다.

## 주요 특징

### 1. 매도 신호 무시

- `SELL_TREND`, `SELL_RSI`, `CUT_STOPLOSS`, `SELL_REPLACE` 등 모든 매도 신호를 무시합니다.
- 핵심 보유 종목은 `HOLD_CORE` 상태로 표시됩니다.
- `HOLD_CORE`는 `DECISION_CONFIG`에서 `order=2`로 설정되어 `HOLD` 바로 아래에 표시됩니다.

### 2. 미보유 시 자동 매수

- 핵심 보유 종목이 포트폴리오에 없으면 자동으로 `BUY` 신호가 생성됩니다.
- 매수 우선순위가 일반 종목보다 높습니다.

### 3. TOPN 계산에서 제외

- `PORTFOLIO_TOPN`이 5이고 핵심 보유 종목이 3개라면, 총 8개 종목을 보유합니다.
- 핵심 보유 종목은 TOPN 슬롯을 차지하지 않습니다.

### 4. 교체 매매 대상에서 제외

- 핵심 보유 종목은 교체 매매 로직에서 매도 대상으로 선정되지 않습니다.

### 5. Universe 유효성 검증

- 핵심 보유 종목이 Universe(종목 리스트)에 포함되어 있는지 검증합니다.
- Universe에 없는 종목은 경고 로그를 출력하고 무시합니다.

## 설정 방법

### 계정 설정 파일 (예: `zsettings/account/k1.json`)

```json
{
  "strategy": {
    "tuning": {
      "MA_PERIOD": 47,
      "MA_TYPE": "SMA",
      "PORTFOLIO_TOPN": 5,
      "REPLACE_SCORE_THRESHOLD": 0.5,
      "OVERBOUGHT_SELL_THRESHOLD": 17,
      "COOLDOWN_DAYS": 1,
      "CORE_HOLDINGS": ["091160", "426030", "473640"]
    }
  }
}
```

### 파라미터 설명

- `CORE_HOLDINGS`: 핵심 보유 종목 티커 리스트
  - 배열 형식: `["091160", "426030", "473640"]`
  - 쉼표로 구분된 문자열도 지원: `"091160,426030,473640"`
  - 빈 배열 또는 생략 시: 핵심 보유 종목 없음

## 예시

### 설정 예시

```json
"CORE_HOLDINGS": ["091160", "426030", "473640"]
```

위 설정은 다음 3개 종목을 핵심 보유 종목으로 지정합니다:

- `091160`: KODEX 반도체
- `426030`: TIMEFOLIO 미국나스닥100액티브
- `473640`: HANARO 글로벌 금채굴기업

### 포트폴리오 구성 예시

- `PORTFOLIO_TOPN`: 5
- `CORE_HOLDINGS`: 3개
- **총 보유 종목**: 8개 (일반 5개 + 핵심 3개)

## 로그 확인

### 추천 시스템

```
[K1] 핵심 보유 종목 (TOPN 제외): ['091160', '426030', '473640']
```

### 백테스트

```
[백테스트] 핵심 보유 종목 (TOPN 제외): ['091160', '426030', '473640']
```

### 유효성 검증 실패 시

```
[K1] CORE_HOLDINGS에 Universe에 없는 종목이 포함됨: {'999999'}
```

## 구현 파일

### 1. 전략 규칙 정의

- **파일**: `strategies/maps/rules.py`
- **클래스**: `StrategyRules`
- **필드**: `core_holdings: List[str]`

### 2. 추천 시스템

- **파일**: `logic/recommend/portfolio.py`
- **함수**: `generate_daily_recommendations_for_portfolio`
- **로직**:
  - 매도 신호 무시
  - 미보유 시 자동 매수
  - TOPN 계산에서 제외
  - 교체 매매 대상에서 제외

### 3. 백테스트

- **파일**: `logic/backtest/portfolio_runner.py`
- **함수**: `run_portfolio_backtest`
- **파라미터**: `core_holdings: Optional[List[str]]`

### 4. 계정 백테스트 러너

- **파일**: `logic/backtest/account_runner.py`
- **함수**: `_build_backtest_kwargs`
- **전달**: `strategy_rules.core_holdings`

## 주의사항

1. **Universe 포함 필수**: 핵심 보유 종목은 반드시 Universe(종목 리스트)에 포함되어야 합니다.
2. **TOPN 추가**: 핵심 보유 종목은 TOPN에 추가되므로, 실제 보유 종목 수는 `TOPN + len(CORE_HOLDINGS)`입니다.
3. **리스크 관리**: 핵심 보유 종목은 손절매도 적용되지 않으므로, 신중하게 선정해야 합니다.
4. **백테스트 반영**: 백테스트와 실시간 추천 모두에 동일하게 적용됩니다.

## 보유 종목 정의

**`HOLD + HOLD_CORE = 전체 보유 종목`**

- `HOLD`: 일반 보유 종목 (교체 매매 대상)
- `HOLD_CORE`: 핵심 보유 종목 (매도 금지, 교체 매매 제외)

## 테스트 결과

### 추천 시스템 (2025-10-21)

```text
| 순위 | 티커   | 종목명                             | 상태      | 점수  | RSI   | 문구         |
|------|--------|------------------------------------|-----------|-------|-------|--------------|
|    1 | 417450 | RISE 글로벌수소경제                | HOLD      | 24.06 | 39.61 |              |
|    2 | 091160 | KODEX 반도체                       | HOLD_CORE | 31.30 | 18.24 | 🔒 핵심 보유 |
|    3 | 473640 | HANARO 글로벌 금채굴기업           | HOLD_CORE | 18.02 | 34.98 | 🆕 신규 편입 |
|    4 | 426030 | TIMEFOLIO 미국나스닥100액티브      | HOLD_CORE |  8.91 | 35.85 | 🆕 신규 편입 |
```

- 핵심 보유 종목 3개(091160, 426030, 473640)가 모두 `HOLD_CORE` 상태로 표시됨
- 일반 종목 5개 + 핵심 보유 종목 3개 = 총 8개 종목 보유
- `HOLD_CORE`는 `HOLD` 바로 아래에 표시됨 (order=2)

### 백테스트 (12개월)

- **누적 수익률**: +65.30%
- **CAGR**: +65.36%
- **MDD**: -16.57%
- **Sharpe Ratio**: 2.33

## 버전 이력

- **v1.0.0** (2025-10-21): 핵심 보유 종목 기능 최초 구현
  - 매도 신호 무시
  - 미보유 시 자동 매수
  - TOPN 계산에서 제외
  - Universe 유효성 검증
  - 백테스트 및 추천 시스템 적용
